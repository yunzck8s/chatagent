<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>与 LLM 对话</title>
    <style>
        /* 页面和容器样式 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            justify-content: center;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #chat-container {
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            height: 90vh;
        }
        h1 {
            text-align: center;
            color: #333;
            margin: 0 0 1rem;
        }
        /* 模型选择区 */
        #model-selection {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        #provider-select, #model-select {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 0.9em;
            flex: 1;
        }
        /* 聊天记录显示区 */
        #chat-box {
            flex-grow: 1;
            border: 1px solid #eaeaea;
            overflow-y: scroll;
            padding: 1rem;
            border-radius: 8px;
            background-color: #ffffff;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        #chat-box p {
            margin: 0;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            line-height: 1.5;
            max-width: 85%;
            word-wrap: break-word;
        }
        /* 用户消息样式 */
        .user-message {
            background-color: #dcf8c6;
            align-self: flex-end;
        }
        /* 机器人消息样式 */
        .bot-message {
            background-color: #f1f0f0;
            align-self: flex-start;
        }
        /* 系统/工具消息样式 */
        .system-message {
            font-size: 0.9em;
            color: #666;
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            align-self: center;
            width: 90%;
            text-align: center;
        }
        /* 工具确认区 */
        .tool-confirmation {
            background-color: #fff3e0;
            border: 1px solid #ff9800;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
            align-self: center;
            width: 90%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tool-confirmation button {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .confirm-btn {
            background-color: #4caf50;
            color: white;
        }
        .cancel-btn {
            background-color: #f44336;
            color: white;
        }
        /* 输入区 */
        #input-area {
            display: flex;
            gap: 1rem;
        }
        #message-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
        }
        #send-button {
            padding: 0.75rem 1.5rem;
            border: none;
            background-color: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        #send-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <h1>与 LLM 对话</h1>
        <div id="model-selection">
            <select id="provider-select">
                <option value="ollama">Ollama</option>
                <option value="deepseek">DeepSeek</option>
            </select>
            <select id="model-select"></select>
        </div>
        <div id="chat-box"></div>
        <div id="input-area">
            <input type="text" id="message-input" placeholder="在这里输入你的消息...">
            <button id="send-button">发送</button>
        </div>
    </div>

<script>
    // --- 1. 获取页面上的元素 ---
    const chatBox = document.getElementById('chat-box');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const providerSelect = document.getElementById('provider-select');
    const modelSelect = document.getElementById('model-select');

    let currentThreadId = null;

    // --- 2. 模型选择逻辑 ---
    async function updateModelOptions() {
        try {
            const response = await fetch('/models');
            if (!response.ok) throw new Error('Failed to fetch models');
            const allModels = await response.json();

            const selectedProvider = providerSelect.value;
            modelSelect.innerHTML = '';

            if (allModels[selectedProvider]) {
                allModels[selectedProvider].forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    modelSelect.appendChild(option);
                });
            } else {
                modelSelect.innerHTML = '<option disabled>No models available</option>';
            }
        } catch (error) {
            console.error('Failed to load models:', error);
            modelSelect.innerHTML = '<option disabled>Error loading models</option>';
        }
    }

    // --- 3. 绑定事件 ---
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
    });
    providerSelect.addEventListener('change', updateModelOptions);
    document.addEventListener('DOMContentLoaded', updateModelOptions);


    // --- 4. 核心函数 ---
    async function sendMessage() {
        const userMessage = messageInput.value.trim();
        if (!userMessage) return;

        appendMessage('你', userMessage, 'user-message');
        messageInput.value = '';

        const botP = appendMessage('机器人', '', 'bot-message', true);

        await fetchAndProcessStream('/chat', {
            text: userMessage,
            provider: providerSelect.value,
            model: modelSelect.value,
            thread_id: currentThreadId
        }, botP);
    }

    function showToolConfirmation(toolNames, toolChoice, threadId) {
        const confirmationDiv = document.createElement('div');
        confirmationDiv.className = 'tool-confirmation';
        confirmationDiv.innerHTML = `
            <span>模型想用工具: <strong>${toolNames.join(', ')}</strong></span>
            <div>
                <button class="confirm-btn">确认</button>
                <button class="cancel-btn">取消</button>
            </div>
        `;
        chatBox.appendChild(confirmationDiv);
        scrollToBottom();

        confirmationDiv.querySelector('.confirm-btn').addEventListener('click', () => {
            confirmTool(toolChoice, threadId);
            confirmationDiv.remove();
        });

        confirmationDiv.querySelector('.cancel-btn').addEventListener('click', () => {
            cancelTool(confirmationDiv);
        });
    }

    async function confirmTool(toolChoice, threadId) {
        appendMessage('系统', `已确认执行工具: ${toolChoice.map(tc => tc.name).join(', ')}...`, 'system-message');
        const botP = appendMessage('机器人', '', 'bot-message', true);

        await fetchAndProcessStream('/continue', {
            thread_id: threadId,
            tool_choice: toolChoice
        }, botP);
    }

    function cancelTool(confirmationDiv) {
        confirmationDiv.remove();
        appendMessage('系统', '已取消工具执行。', 'system-message');
    }

    async function fetchAndProcessStream(endpoint, body, botParagraphElement) {
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });

            if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            botParagraphElement.textContent = ''; // 清空占位符的"机器人:"文本

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonData = JSON.parse(line.substring(6));

                        if (jsonData.type === 'content') {
                            botParagraphElement.innerHTML += jsonData.content.replace(/\n/g, '<br>');
                            scrollToBottom();
                        } else if (jsonData.type === 'tool_request') {
                            currentThreadId = jsonData.thread_id;
                            showToolConfirmation(jsonData.content, jsonData.tool_choice, jsonData.thread_id);
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error:', error);
            botParagraphElement.innerHTML += '<span style="color: red;">抱歉，出错了。请检查后端服务是否正常。</span>';
        }
    }

    function appendMessage(user, text, className, isPlaceholder = false) {
        const p = document.createElement('p');
        p.className = className;
        const strong = document.createElement('strong');
        strong.textContent = `${user}: `;
        p.appendChild(strong);

        if (!isPlaceholder) {
           p.innerHTML += text.replace(/\n/g, '<br>');
        }

        chatBox.appendChild(p);
        scrollToBottom();
        return p;
    }

    function scrollToBottom() {
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
</body>
</html>